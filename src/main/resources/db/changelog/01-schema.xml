<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
       http://www.liquibase.org/xml/ns/dbchangelog
       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- ================= Users / Auth ================= -->
    <changeSet id="1-create-users-table" author="ziyihuang">
        <createTable tableName="users">
            <column name="id" type="CHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password_hash" type="VARCHAR(255)"/>
            <column name="is_verified" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="password_set" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>

    <!-- ================= Email verification codes ================= -->
    <changeSet id="2-create-email-codes-table" author="ziyihuang">
        <createTable tableName="email_verification_codes">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            <column name="purpose" type="VARCHAR(50)"/>
            <column name="expires_at" type="TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="email_verification_codes" indexName="idx_email_code">
            <column name="email"/>
        </createIndex>
    </changeSet>

    <!-- ================= Posts ================= -->
    <changeSet id="3-create-posts-table" author="ziyihuang">
        <createTable tableName="posts">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="CHAR(36)"/>
            <column name="content" type="TEXT"/>
            <column name="wall" type="VARCHAR(20)" defaultValue="campus"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="posts" baseColumnNames="user_id"
                                 constraintName="fk_posts_user"
                                 referencedTableName="users" referencedColumnNames="id"/>
    </changeSet>

    <!-- ================= Comments ================= -->
    <changeSet id="4-create-comments-table" author="ziyihuang">
        <createTable tableName="comments">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="post_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" type="CHAR(36)"/>
            <column name="text" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="comments" baseColumnNames="post_id"
                                 constraintName="fk_comments_post"
                                 referencedTableName="posts" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="comments" baseColumnNames="user_id"
                                 constraintName="fk_comments_user"
                                 referencedTableName="users" referencedColumnNames="id"/>
    </changeSet>

    <!-- ================= Post Likes ================= -->
    <changeSet id="5-create-post-likes-table" author="ziyihuang">
        <createTable tableName="post_likes">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="post_id" type="BIGINT"/>
            <column name="user_id" type="CHAR(36)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="post_likes" baseColumnNames="post_id"
                                 constraintName="fk_post_likes_post"
                                 referencedTableName="posts" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="post_likes" baseColumnNames="user_id"
                                 constraintName="fk_post_likes_user"
                                 referencedTableName="users" referencedColumnNames="id"/>
        <addUniqueConstraint tableName="post_likes" columnNames="post_id,user_id"
                             constraintName="uk_post_likes_user_post"/>
    </changeSet>

    <!-- ================= Internships ================= -->
    <changeSet id="6-create-internships-table" author="ziyihuang">
        <createTable tableName="internships">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="CHAR(36)"/>
            <column name="company" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="salary" type="VARCHAR(50)"/>
            <column name="location" type="VARCHAR(255)"/>
            <column name="description" type="TEXT"/>
            <column name="deadline" type="DATE"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="internships" baseColumnNames="user_id"
                                 constraintName="fk_internships_user"
                                 referencedTableName="users" referencedColumnNames="id"/>
        <createIndex tableName="internships" indexName="idx_internships_company">
            <column name="company"/>
        </createIndex>
        <createIndex tableName="internships" indexName="idx_internships_created_at">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <!-- ================= Marketplace Items ================= -->
    <changeSet id="7-create-marketplace-table" author="ziyihuang">
        <createTable tableName="marketplace_items">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="CHAR(36)"/>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="price" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="category" type="VARCHAR(100)"/>
            <column name="condition" type="VARCHAR(20)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="marketplace_items" baseColumnNames="user_id"
                                 constraintName="fk_marketplace_user"
                                 referencedTableName="users" referencedColumnNames="id"/>
        <createIndex tableName="marketplace_items" indexName="idx_marketplace_created_at">
            <column name="created_at"/>
        </createIndex>
        <createIndex tableName="marketplace_items" indexName="idx_marketplace_price">
            <column name="price"/>
        </createIndex>
    </changeSet>

    <!-- ================= Coins ================= -->
    <changeSet id="8-create-coins-table" author="ziyihuang">
        <createTable tableName="coins">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="user_id" type="CHAR(36)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="balance" type="INT" defaultValueNumeric="0"/>
            <column name="last_claim_date" type="DATE"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="coins" baseColumnNames="user_id"
                                 constraintName="fk_coins_user"
                                 referencedTableName="users" referencedColumnNames="id"/>
    </changeSet>

    <!-- ================= Indexes for Performance ================= -->
    <changeSet id="9-add-performance-indexes" author="ziyihuang">
        <!-- Posts indexes -->
        <createIndex tableName="posts" indexName="idx_posts_wall">
            <column name="wall"/>
        </createIndex>
        <createIndex tableName="posts" indexName="idx_posts_user_id">
            <column name="user_id"/>
        </createIndex>
        <createIndex tableName="posts" indexName="idx_posts_wall_created_at">
            <column name="wall"/>
            <column name="created_at"/>
        </createIndex>

        <!-- Comments indexes -->
        <createIndex tableName="comments" indexName="idx_comments_post_id">
            <column name="post_id"/>
        </createIndex>
        <createIndex tableName="comments" indexName="idx_comments_user_id">
            <column name="user_id"/>
        </createIndex>

        <!-- Email verification codes indexes -->
        <createIndex tableName="email_verification_codes" indexName="idx_email_expires_at">
            <column name="expires_at"/>
        </createIndex>

        <!-- Post likes indexes -->
        <createIndex tableName="post_likes" indexName="idx_post_likes_user_id">
            <column name="user_id"/>
        </createIndex>

        <!-- Marketplace indexes -->
        <createIndex tableName="marketplace_items" indexName="idx_marketplace_user_id">
            <column name="user_id"/>
        </createIndex>

        <!-- Internships indexes -->
        <createIndex tableName="internships" indexName="idx_internships_user_id">
            <column name="user_id"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
